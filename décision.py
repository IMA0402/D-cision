import streamlit as st
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
import arabic_reshaper
from bidi.algorithm import get_display
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.metrics import accuracy_score

# ๐ ุฅุนุฏุงุฏ ุงูุฎุท ูุฏุนู ุงูุนุฑุจูุฉ
plt.rcParams['font.family'] = 'Arial'
plt.rcParams['axes.unicode_minus'] = False

# ๐ ุฅุนุฏุงุฏ ูุงุฌูุฉ ุงูุชุทุจูู
st.title("๐ ุชุทุจูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุญููู ุงูุญููุงุช ุงูุชุณููููุฉ")
st.write("๐ ุฃุฏุฎู ุจูุงูุงุช ุญููุชู ุงูุชุณููููุฉ ููุญุตูู ุนูู ุชูุตูุงุช ุชุนุชูุฏ ุนูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู.")

# ๐ ุฅุฏุฎุงู ุจูุงูุงุช ุงูุญููุฉ
ุงูููุฒุงููุฉ = st.number_input("๐ฐ ููุฒุงููุฉ ุงูุญููุฉ (ุงูุฏุฑูู ุงููุบุฑุจู):", min_value=1000, max_value=100000, step=500)
ุงูููุงุฉ = st.selectbox("๐ก ุงูููุงุฉ ุงูุชุณููููุฉ:", ["ุฅุนูุงูุงุช ุฑูููุฉ", "ูุณุงุฆู ุงูุชูุงุตู", "ุชููุฒููู", "ุฑุงุฏูู", "ุจุฑูุฏ ุฅููุชุฑููู"])
ุงูุฌูููุฑ = st.selectbox("๐ฅ ุงููุฆุฉ ุงููุณุชูุฏูุฉ:", ["18-24", "25-34", "35-44", "45-54", "55+"])
ุงููุฏุฉ = st.slider("โณ ูุฏุฉ ุงูุญููุฉ (ุจุงูุฃูุงู):", min_value=7, max_value=90, step=7)
ุญุงูุฉ_ุงูุณูู = st.selectbox("๐ ุญุงูุฉ ุงูุณูู:", ["ุทุจูุนูุฉ", "ุฃุฒูุฉ ููุฑููุง", "ุฃุฒูุฉ ุงูุชุตุงุฏูุฉ"])

# ๐ ูุนุงูุฌุฉ ุงูุจูุงูุงุช
df = pd.DataFrame({
    "ุงูููุฒุงููุฉ": np.random.randint(1000, 50000, 100),
    "ุงูููุงุฉ": np.random.choice(["ุฅุนูุงูุงุช ุฑูููุฉ", "ูุณุงุฆู ุงูุชูุงุตู", "ุชููุฒููู", "ุฑุงุฏูู", "ุจุฑูุฏ ุฅููุชุฑููู"], 100),
    "ุงูุฌูููุฑ": np.random.choice(["18-24", "25-34", "35-44", "45-54", "55+"], 100),
    "ุงููุฏุฉ": np.random.randint(7, 90, 100),
    "ุญุงูุฉ_ุงูุณูู": np.random.choice(["ุทุจูุนูุฉ", "ุฃุฒูุฉ ููุฑููุง", "ุฃุฒูุฉ ุงูุชุตุงุฏูุฉ"], 100),
    "ุงููุฌุงุญ": np.random.choice([0, 1], 100)
})

# ๐ ุชุฑููุฒ ุงูููู (ุฅูุดุงุก ุชุฑููุฒ ูููุตู ููู ุนููุฏ)
le_ุงูููุงุฉ = LabelEncoder()
df["ุงูููุงุฉ"] = le_ุงูููุงุฉ.fit_transform(df["ุงูููุงุฉ"])

le_ุงูุฌูููุฑ = LabelEncoder()
df["ุงูุฌูููุฑ"] = le_ุงูุฌูููุฑ.fit_transform(df["ุงูุฌูููุฑ"])

le_ุญุงูุฉ_ุงูุณูู = LabelEncoder()
df["ุญุงูุฉ_ุงูุณูู"] = le_ุญุงูุฉ_ุงูุณูู.fit_transform(df["ุญุงูุฉ_ุงูุณูู"])

# ๐ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช
X = df[["ุงูููุฒุงููุฉ", "ุงูููุงุฉ", "ุงูุฌูููุฑ", "ุงููุฏุฉ", "ุญุงูุฉ_ุงูุณูู"]]
y = df["ุงููุฌุงุญ"]
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# ๐ ุชุฏุฑูุจ ุงููููุฐุฌ
model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

# ๐ ุชุญููู ุงูููุฒุงุช
importances = model.feature_importances_
importance_df = pd.DataFrame({"ุงูููุฒุฉ": X.columns, "ุงูุฃูููุฉ": importances}).sort_values(by="ุงูุฃูููุฉ", ascending=False)

# ๐ ุฏูุฉ ุงููููุฐุฌ
accuracy = accuracy_score(y_test, model.predict(X_test))
st.write(f"๐ **ุฏูุฉ ุงููููุฐุฌ: {accuracy * 100:.2f} ูู ุงููุฆุฉ**")

# ๐ ุชูุณูุฑ ุงููุชุงุฆุฌ
# ุงูุชุญูู ูู ูุฌูุฏ ุงููุฆุงุช ุงูุฌุฏูุฏุฉ ูุฅุถุงูุชูุง ุฅุฐุง ูุฒู ุงูุฃูุฑ
if ุงูููุงุฉ not in le_ุงูููุงุฉ.classes_:
    le_ุงูููุงุฉ.classes_ = np.append(le_ุงูููุงุฉ.classes_, ุงูููุงุฉ)
if ุงูุฌูููุฑ not in le_ุงูุฌูููุฑ.classes_:
    le_ุงูุฌูููุฑ.classes_ = np.append(le_ุงูุฌูููุฑ.classes_, ุงูุฌูููุฑ)
if ุญุงูุฉ_ุงูุณูู not in le_ุญุงูุฉ_ุงูุณูู.classes_:
    le_ุญุงูุฉ_ุงูุณูู.classes_ = np.append(le_ุญุงูุฉ_ุงูุณูู.classes_, ุญุงูุฉ_ุงูุณูู)

# ุงูุชูุจุค
new_data = pd.DataFrame([[ุงูููุฒุงููุฉ, le_ุงูููุงุฉ.transform([ุงูููุงุฉ])[0], le_ุงูุฌูููุฑ.transform([ุงูุฌูููุฑ])[0], ุงููุฏุฉ, le_ุญุงูุฉ_ุงูุณูู.transform([ุญุงูุฉ_ุงูุณูู])[0]]],
                        columns=["ุงูููุฒุงููุฉ", "ุงูููุงุฉ", "ุงูุฌูููุฑ", "ุงููุฏุฉ", "ุญุงูุฉ_ุงูุณูู"])

prediction = model.predict(new_data)[0]
result = "ูุฌุงุญ ๐ฏ" if prediction == 1 else "ูุดู โ๏ธ"

# ๐ ุชูุฑูุฑ ุชุญูููู ุดุงูู
analysis = f"""
๐ **ุชูุฑูุฑ ุชุญูููู ุดุงูู ุญูู ุงูุญููุฉ ุงูุชุณููููุฉ:**  
- ุจูุงุกู ุนูู ุงูููุฒุงููุฉ ุงููุญุฏุฏุฉ ({ุงูููุฒุงููุฉ}) ูุงุฎุชูุงุฑ ุงูููุงุฉ ุงูุชุณููููุฉ ({ุงูููุงุฉ})ุ ุชู ุชุญููู ุงููุนุทูุงุช ูุงูุชูุจุค ุจูุชูุฌุฉ ุงูุญููุฉ.  
- ุงููุฆุฉ ุงููุณุชูุฏูุฉ ({ุงูุฌูููุฑ}) ุชูุนุจ ุฏูุฑุงู ูุญูุฑูุงู ูู ูุฌุงุญ ุงูุญููุฉุ ุจุงูุฅุถุงูุฉ ุฅูู ูุฏุฉ ุงูุญููุฉ ุงููุญุฏุฏุฉ ({ุงููุฏุฉ} ุฃูุงู).  
- ุชู ุงูุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุญุงูุฉ ุงูุณูู ุงูุญุงููุฉ ({ุญุงูุฉ_ุงูุณูู}) ูุงูุชู ูุฏ ุชุคุซุฑ ุจุดูู ููุญูุธ ุนูู ุงูุฃุฏุงุก.  
- **ูุชูุฌุฉ ุงูุชูุจุค:** ุงูุญููุฉ ูู ุงููุญุชูู ุฃู ุชููู ุจูุณุจุฉ ุนุงููุฉ **{result}**.  
- **ุชุญููู ุงูููุฒุงุช ุงููุคุซุฑุฉ:**  
"""

for index, row in importance_df.iterrows():
    analysis += f"- **{row['ุงูููุฒุฉ']}**: ูุณุชูู ุชุฃุซูุฑู ุนูู ุงููุฌุงุญ ูู **{row['ุงูุฃูููุฉ']:.2f}**.\n"

st.write(analysis)

# ๐ ุฑุณู ุงููุฎุทุทุงุช
# ูุซุงู ูุจูุงูุงุช ุงูุฃูููุฉ
importance_df = pd.DataFrame({
    "ุงูููุฒุฉ": ["ููุงุฉ ุงูุชุณููู", "ุงููุฆุฉ ุงูุนูุฑูุฉ", "ุงูููุฒุงููุฉ", "ุงููุฏุฉ", "ุญุงูุฉ ุงูุณูู"],
    "ุงูุฃูููุฉ": [0.25, 0.20, 0.30, 0.15, 0.10]
})

# ุฅุนุงุฏุฉ ุชุดููู ุงููุตูุต ุงูุนุฑุจูุฉ
importance_df["ุงูููุฒุฉ"] = importance_df["ุงูููุฒุฉ"].apply(lambda x: get_display(arabic_reshaper.reshape(x)))

st.subheader("๐ ุฃูููุฉ ุงูููุฒุงุช ูู ุงุชุฎุงุฐ ุงููุฑุงุฑ")
fig, ax = plt.subplots()

# ุชูุนูู ุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ
plt.rcParams['font.family'] = 'Arial'
plt.rcParams['axes.unicode_minus'] = False

# ุฅุนุงุฏุฉ ุชุดููู ุงููุต ุงูุนุฑุจู ููุธูุฑ ุจุดูู ุตุญูุญ
title = get_display(arabic_reshaper.reshape("ูุฎุทุท ุฃูููุฉ ุงูููุฒุงุช"))
xlabel = get_display(arabic_reshaper.reshape("ุงูุฃูููุฉ"))
ylabel = get_display(arabic_reshaper.reshape("ุงูููุฒุฉ"))

# ุฑุณู ุงููุฎุทุท ุจุงุณุชุฎุฏุงู Seaborn
sns.barplot(x="ุงูุฃูููุฉ", y="ุงูููุฒุฉ", data=importance_df, palette="viridis", ax=ax)

# ุถุจุท ุนููุงู ุงููุฎุทุท ูุงูุนูุงููู ุงููุฑุนูุฉ
ax.set_title(title, fontsize=16, fontweight='bold', fontname='Arial', loc='center')
ax.set_xlabel(xlabel, fontsize=14, fontname='Arial')
ax.set_ylabel(ylabel, fontsize=14, fontname='Arial')

# ุถุจุท ุงุชุฌุงู ุงููุต ุนูู ุงููุญุงูุฑ
plt.xticks(fontsize=12, fontname='Arial')
plt.yticks(fontsize=12, fontname='Arial')

# ููุจ ุชุฑุชูุจ ุงูููุฒุงุช ูุนุฑุถูุง ูู ุงูุฃุนูู ููุฃุณูู
plt.gca().invert_yaxis()

st.pyplot(fig)

# ๐ ุชุญููู ูุฎุทุท ุฃูููุฉ ุงูููุฒุงุช
# ุฅุนุงุฏุฉ ุชุดููู ุงููุตูุต ูู DataFrame ูุถูุงู ุธููุฑูุง ุจุดูู ุตุญูุญ
ุงูููุฒุฉ_ุงูุฃูุซุฑ_ุฃูููุฉ = get_display(arabic_reshaper.reshape(importance_df.iloc[0]["ุงูููุฒุฉ"]))
ุงูููุฒุฉ_ุงูุฃูู_ุฃูููุฉ = get_display(arabic_reshaper.reshape(importance_df.iloc[-1]["ุงูููุฒุฉ"]))

st.markdown(f"""
๐ **ุชุญููู ูุฎุทุท ุฃูููุฉ ุงูููุฒุงุช:**  
ูุธูุฑ ุงููุฎุทุท ุฃุนูุงู ุฃู ุงูููุฒุฉ ุงูุฃูุซุฑ ุฃูููุฉ ูู ุชุญุฏูุฏ ูุฌุงุญ ุงูุญููุงุช ูู **{ุงูููุฒุฉ_ุงูุฃูุซุฑ_ุฃูููุฉ}**ุ ููุง ูุดูุฑ ุฅูู ุฃู ุงูุชุฑููุฒ ุนูู ูุฐู ุงูููุฒุฉ ูููู ุฃู ูุณุงูู ุจุดูู ูุจูุฑ ูู ุชุญููู ุงููุฌุงุญ.  
ูู ูุงุญูุฉ ุฃุฎุฑูุ ุชูุนุฏ ููุฒุฉ **{ุงูููุฒุฉ_ุงูุฃูู_ุฃูููุฉ}** ุงูุฃูู ุชุฃุซูุฑูุงุ ููุง ูุนูู ุฃู ุงูุงุณุชุซูุงุฑ ูู ุชุญุณูููุง ูุฏ ูุง ูููู ูู ููุณ ุงูุฃุซุฑ.  
""")

# ๐ ุฑุณู ุงูุนูุงูุฉ ุจูู ุงูููุฒุงููุฉ ูุงููุฌุงุญ
st.subheader("๐ธ ุชุฃุซูุฑ ุงูููุฒุงููุฉ ุนูู ูุฌุงุญ ุงูุญููุฉ")
fig2, ax2 = plt.subplots()

# ุชูุนูู ุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ
plt.rcParams['font.family'] = 'Arial'
plt.rcParams['axes.unicode_minus'] = False

# ุฑุณู ุงููุฎุทุท
sns.boxplot(x="ุงููุฌุงุญ", y="ุงูููุฒุงููุฉ", data=df, palette="cool", ax=ax2)

# ุฅุนุงุฏุฉ ุชุดููู ุงููุต ุงูุนุฑุจู ููุธูุฑ ุจุดูู ุตุญูุญ
title = get_display(arabic_reshaper.reshape("ุชุฃุซูุฑ ุงูููุฒุงููุฉ ุนูู ูุฌุงุญ ุงูุญููุฉ"))
xlabel = get_display(arabic_reshaper.reshape("ุงููุฌุงุญ"))
ylabel = get_display(arabic_reshaper.reshape("ุงูููุฒุงููุฉ"))

# ุถุจุท ุนููุงู ุงููุฎุทุท ูุงูุนูุงููู ุงููุฑุนูุฉ
ax2.set_title(title, fontsize=16, fontweight='bold', fontname='Arial', loc='center')
ax2.set_xlabel(xlabel, fontsize=14, fontname='Arial')
ax2.set_ylabel(ylabel, fontsize=14, fontname='Arial')

# ุถุจุท ุงุชุฌุงู ุงููุต ุนูู ุงููุญุงูุฑ
plt.xticks(fontsize=12, fontname='Arial')
plt.yticks(fontsize=12, fontname='Arial')

st.pyplot(fig2)

# ๐ ุชุญููู ุงูุนูุงูุฉ ุจูู ุงูููุฒุงููุฉ ูุงููุฌุงุญ
ูุชูุณุท_ููุฒุงููุฉ_ุงููุฌุงุญ = df[df["ุงููุฌุงุญ"] == 1]["ุงูููุฒุงููุฉ"].mean()
ูุชูุณุท_ููุฒุงููุฉ_ุงููุดู = df[df["ุงููุฌุงุญ"] == 0]["ุงูููุฒุงููุฉ"].mean()
st.markdown(f"""
๐ **ุชุญููู ุชุฃุซูุฑ ุงูููุฒุงููุฉ ุนูู ุงููุฌุงุญ:**  
ุชูุธูุฑ ุงูุจูุงูุงุช ุฃู ุงูููุฒุงููุฉ ุงููุชูุณุทุฉ ููุญููุงุช ุงููุงุฌุญุฉ ูู ุญูุงูู **{ูุชูุณุท_ููุฒุงููุฉ_ุงููุฌุงุญ:.2f} ุฏุฑูู**ุ ุจูููุง ุงูููุฒุงููุฉ ุงููุชูุณุทุฉ ููุญููุงุช ุบูุฑ ุงููุงุฌุญุฉ ูู ุญูุงูู **{ูุชูุณุท_ููุฒุงููุฉ_ุงููุดู:.2f} ุฏุฑูู**.  
ูุดูุฑ ุฐูู ุฅูู ุฃู ุงูุญููุงุช ุฐุงุช ุงูููุฒุงููุงุช ุงูุฃุนูู ุชููู ุฅูู ุชุญููู ูุฌุงุญ ุฃูุจุฑ. ูุฐูู ูููุตุญ ุจุชุฎุตูุต ููุฒุงููุฉ ููุงุณุจุฉ ููุญููุงุช ูุถูุงู ูุฌุงุญูุง.
""")

# ๐ก ุชุฃุซูุฑ ุงูููุงุฉ ุงูุชุณููููุฉ ุนูู ูุฌุงุญ ุงูุญููุฉ
st.subheader("๐ก ุชุฃุซูุฑ ุงูููุงุฉ ุงูุชุณููููุฉ ุนูู ูุฌุงุญ ุงูุญููุฉ")
fig3, ax3 = plt.subplots()

# ุชูุนูู ุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ
plt.rcParams['font.family'] = 'Arial'
plt.rcParams['axes.unicode_minus'] = False

# ุฅุนุงุฏุฉ ุชุดููู ุงููุต ุงูุนุฑุจู ููุธูุฑ ุจุดูู ุตุญูุญ
title = get_display(arabic_reshaper.reshape("ูุฌุงุญ ุงูุญููุงุช ุญุณุจ ุงูููุงุฉ"))
xlabel = get_display(arabic_reshaper.reshape("ุงูููุงุฉ ุงูุชุณููููุฉ"))
ylabel = get_display(arabic_reshaper.reshape("ุนุฏุฏ ุงูุญููุงุช"))
legend_title = get_display(arabic_reshaper.reshape("ุงููุฌุงุญ"))

# ุฑุณู ุงููุฎุทุท ูุน ูุณููุฉ ุงูุฅูุถุงุญ
sns.countplot(data=df, x="ุงูููุงุฉ", hue="ุงููุฌุงุญ", palette="cool", ax=ax3)
ax3.set_title(title, fontsize=16, fontweight='bold')
ax3.set_xlabel(xlabel, fontsize=14)
ax3.set_ylabel(ylabel, fontsize=14)

# ุฅุถุงูุฉ ูุณููุฉ ุงูุฅูุถุงุญ ูุน ุนููุงู (ุฅุนุงุฏุฉ ุชุดููู ุงููุต)
ax3.legend(title=legend_title, fontsize=12, title_fontsize=14, loc="upper right")

# ุถุจุท ุฅุนุฏุงุฏุงุช ุงูุฎุทูุท
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)

st.pyplot(fig3)

# ๐ ุชุญููู ูุฌุงุญ ุงูุญููุงุช ุญุณุจ ุงูููุงุฉ
ูุนุฏูุงุช_ูุฌุงุญ_ุงููููุงุช = df.groupby("ุงูููุงุฉ")["ุงููุฌุงุญ"].mean().sort_values(ascending=False)
ุฃูุถู_ููุงุฉ = ูุนุฏูุงุช_ูุฌุงุญ_ุงููููุงุช.idxmax()
ูุนุฏู_ูุฌุงุญ_ุฃูุถู_ููุงุฉ = ูุนุฏูุงุช_ูุฌุงุญ_ุงููููุงุช.max() * 100
ุฃุณูุฃ_ููุงุฉ = ูุนุฏูุงุช_ูุฌุงุญ_ุงููููุงุช.idxmin()
ูุนุฏู_ูุฌุงุญ_ุฃุณูุฃ_ููุงุฉ = ูุนุฏูุงุช_ูุฌุงุญ_ุงููููุงุช.min() * 100
st.markdown(f"""
๐ **ุชุญููู ูุฌุงุญ ุงูุญููุงุช ุญุณุจ ุงูููุงุฉ:**  
ูู ุฎูุงู ุชุญููู ุงูุจูุงูุงุชุ ุชุจููู ุฃู ุงูููุงุฉ ุงูุชุณููููุฉ ุงูุฃูุซุฑ ูุฌุงุญูุง ูู **{ุฃูุถู_ููุงุฉ}** ุจูุณุจุฉ ูุฌุงุญ ุชุจูุบ ุญูุงูู **{ูุนุฏู_ูุฌุงุญ_ุฃูุถู_ููุงุฉ:.2f} ูู ุงููุฆุฉ**.  
ูู ุงูููุงุจูุ ูุงูุช ุงูููุงุฉ ุงูุฃูู ูุฌุงุญูุง ูู **{ุฃุณูุฃ_ููุงุฉ}** ุจูุณุจุฉ ูุฌุงุญ ุชุจูุบ ุญูุงูู **{ูุนุฏู_ูุฌุงุญ_ุฃุณูุฃ_ููุงุฉ:.2f} ูู ุงููุฆุฉ**.  
ููุตู ุจุชุฑููุฒ ุงูุฌููุฏ ุนูู ุงููููุงุช ุงูุฃูุซุฑ ูุงุนููุฉ ุจูุงุกู ุนูู ูุฐู ุงููุชุงุฆุฌ ูุถูุงู ุชุญููู ุฃูุตู ุงุณุชูุงุฏุฉ ูู ุงูููุฒุงููุฉ ุงูุชุณููููุฉ.
""")